<?xml version="1.0" encoding="UTF-8"?>
<project name="Mobicents Common Ant Targets for SLEE Events">
	
	<!--
		
		Common Ant Targets for SLEE Events
		Author: Eduardo Martins
		Portugal Telecom Inovação (www.ptinovacao.pt)
		Contributed to Mobicents Project
		
		To use these targets for your SLEE events project
		there are some issues:
		
			1. You need to define, in the ant build file that will
			   import this one, the properties:	   			   
			       
			     º event.name - this name that will be used to
                   to identify descriptors, name jars and temp dirs;
                   			     
			     º event.src.path - the relative path, from project's
			       home, to the event source files;
			       
		    2. The SLEE service descriptors files must be named:
		       
		         º event jar descriptor - event.name + "-event-jar.xml"
		         	         
		         º deployable unit jar descriptor - event.name + "-deployable-unit.xml"
		         
		    3. Dir "classes" will be used to compile source files
		    
   		    4. Jars will be created in "jars" dir
   		    
		    5. Event jar will be named event.name + "-event.jar"
		       
		    6. Event deployable unit jar will be named event.name + "-DU.jar"
		    
		    7. You may use the target named add-other-jars-to-DU to add
		       other jars/classes to your deployable unit. To use this you need to
		       define a fileset with id "event.other.jars" with the jars/classes
		       to add		         
		   		   
	-->
	
	<fileset id="event.other.jars" file="." />
	
	<target name="build-jar">
	  	<mkdir dir="classes/${event.name}-event"/>		
		<mkdir dir="jars"/>
		<javac destdir="classes/${event.name}-event" srcdir="src" debug="true">
		    <classpath>
		    	<path refid="event.classpath"/>
		    </classpath>	
		</javac>		    	
    	<copy todir="classes/${event.name}-event/${event.src.path}">
    	    <fileset dir="src/${event.src.path}">
    	     	<exclude name="**/*.java"/>
    	    	<exclude name="${event.name}-deployable-unit.xml"/>
    	    	<exclude name="${event.name}-event-jar.xml"/>
    	    </fileset>
    	  </copy>    		    	
		<copy file="src/${event.src.path}/${event.name}-event-jar.xml" tofile="classes/${event.name}-event/META-INF/event-jar.xml"/>		    	
    	<jar jarfile="jars/${event.name}-event.jar">    		
    		<fileset dir="classes/${event.name}-event" />
    	</jar> 
    </target>    
	
	<target name="add-other-jars-to-DU">
	   	<copy todir="classes/${event.name}-DU/library">
	   		<fileset refid="event.other.jars" />
	   	</copy>    	
	</target>
	
    <target name="build-DU">
    	<mkdir dir="classes/${event.name}-DU"/>    	
    	<copy file="src/${event.src.path}/${event.name}-deployable-unit.xml" tofile="classes/${event.name}-DU/META-INF/deployable-unit.xml"/>    			
    	<copy todir="classes/${event.name}-DU">
    		<fileset includes="jars/${event.name}-event.jar" dir=""/>        	         		    				
    	</copy>				    	
    	<jar destfile="jars/${event.name}-DU.jar">
    		<fileset dir="classes/${event.name}-DU" />
    	</jar>    	
    </target>
	
	<target name="clean" depends="clean-event, clean-DU" />
	   
	<target name="clean-event">
	    <delete file="jars/${event.name}-event.jar"/>
	    <delete dir="classes/${event.name}-event"/>
	</target>
		
	 <target name="clean-DU">
        <delete file="jars/${event.name}-DU.jar"/>
        <delete dir="classes/${event.name}-DU"/>
    </target>
	
	<target name="create-deploy-url">
		<path id="event.url.to.deploy">		
			<pathelement location="jars/${event.name}-DU.jar"/>
		</path>
		<property name="event.url.to.deploy" refid="event.url.to.deploy"/>
	</target>	
	
	<target name="install-DU" depends="create-deploy-url">		
		<echo>Installing ${event.name} DU in URL ${event.url.to.deploy}</echo>
		<slee-management jnpport="${jnpPort}" jnpHost="${jnpHost}">
			<install url="${file_url}${event.url.to.deploy}"/>				
		</slee-management>
    </target>

	<target name="uninstall-DU" depends="create-deploy-url">		
		<echo>Uninstalling ${event.name} DU in URL ${event.url.to.deploy}</echo>
		<slee-management jnpport="${jnpPort}" jnpHost="${jnpHost}">			
			<uninstall url="${file_url}${event.url.to.deploy}"/>
		</slee-management>
	</target>	
	
	<target name="build-and-install-events" depends="build-jar,build-DU,install-DU" />
		
</project> 